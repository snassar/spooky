name: Integration Tests

on:
  workflow_run:
    workflows: ["Unit Tests"]
    types: [completed]
  workflow_dispatch:

jobs:
  run-integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
        cache: true

    - name: Enable user namespaces
      run: |
        echo 'kernel.unprivileged_userns_clone=1' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p

    - name: Configure subuid/subgid for runner user
      run: |
        sudo usermod --add-subuids 100000-165535 $USER
        sudo usermod --add-subgids 100000-165535 $USER

    - name: Create Podman configuration directory
      run: |
        mkdir -p ~/.config/containers

    - name: Create Podman containers.conf
      run: |
        cat > ~/.config/containers/containers.conf << EOF
        [engine]
        active_service = "podman"
        
        [engine.service_destinations]
        [engine.service_destinations.podman]
        uri = "unix:///run/user/\${UID}/podman/podman.sock"
        
        [engine.service_destinations.podman.connection_timeout_seconds]
        uri = 20
        
        [engine.service_destinations.podman.connection_override]
        uri = "unix:///run/user/\${UID}/podman/podman.sock"
        EOF

    - name: Install Podman
      run: |
        sudo apt-get update
        sudo apt-get install -y podman

    - name: Verify Podman installation
      run: |
        podman --version

    - name: Generate SSH key pair
      run: |
        ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -C "github-actions@spooky"

    - name: Set SSH key permissions
      run: |
        chmod 600 ~/.ssh/id_ed25519
        chmod 644 ~/.ssh/id_ed25519.pub

    - name: Create Dockerfile for SSH container
      run: |
        cat > Dockerfile.ssh << 'EOF'
        FROM debian:12-slim
        
        # Install SSH server and required packages
        RUN apt-get update && apt-get install -y \
            openssh-server \
            sudo \
            && rm -rf /var/lib/apt/lists/*
        
        # Create SSH directory
        RUN mkdir -p /var/run/sshd
        
        # Create test user
        RUN useradd -m -s /bin/bash testuser && \
            echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
        
        # Create .ssh directory for testuser
        RUN mkdir -p /home/testuser/.ssh && \
            chown testuser:testuser /home/testuser/.ssh && \
            chmod 700 /home/testuser/.ssh
        
        # Copy SSH public key
        COPY id_ed25519.pub /home/testuser/.ssh/authorized_keys
        RUN chown testuser:testuser /home/testuser/.ssh/authorized_keys && \
            chmod 600 /home/testuser/.ssh/authorized_keys
        
        # Configure SSH
        RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
            sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
            sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
            sed -i 's/#AuthorizedKeysFile/AuthorizedKeysFile/' /etc/ssh/sshd_config && \
            echo "StrictModes no" >> /etc/ssh/sshd_config
        
        # Expose SSH port
        EXPOSE 22
        
        # Start SSH daemon
        CMD ["/usr/sbin/sshd", "-D"]
        EOF

    - name: Copy SSH public key to build context
      run: |
        cp ~/.ssh/id_ed25519.pub .

    - name: Build SSH container image
      run: |
        podman build -f Dockerfile.ssh -t spooky-test-ssh .

    - name: Create Dockerfile for no-SSH container
      run: |
        cat > Dockerfile.no-ssh << 'EOF'
        FROM debian:12-slim
        
        # Create test user
        RUN useradd -m -s /bin/bash testuser
        
        # Just keep container running without SSH
        CMD ["tail", "-f", "/dev/null"]
        EOF

    - name: Build no-SSH container image
      run: |
        podman build -f Dockerfile.no-ssh -t spooky-test-no-ssh .

    - name: Create Dockerfile for SSH-no-key container
      run: |
        cat > Dockerfile.ssh-no-key << 'EOF'
        FROM debian:12-slim
        
        # Install SSH server and required packages
        RUN apt-get update && apt-get install -y \
            openssh-server \
            sudo \
            && rm -rf /var/lib/apt/lists/*
        
        # Create SSH directory
        RUN mkdir -p /var/run/sshd
        
        # Create test user
        RUN useradd -m -s /bin/bash testuser && \
            echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
        
        # Create .ssh directory for testuser but DON'T add authorized_keys
        RUN mkdir -p /home/testuser/.ssh && \
            chown testuser:testuser /home/testuser/.ssh && \
            chmod 700 /home/testuser/.ssh
        
        # Configure SSH
        RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
            sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
            sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
            sed -i 's/#AuthorizedKeysFile/AuthorizedKeysFile/' /etc/ssh/sshd_config && \
            echo "StrictModes no" >> /etc/ssh/sshd_config
        
        # Expose SSH port
        EXPOSE 22
        
        # Start SSH daemon
        CMD ["/usr/sbin/sshd", "-D"]
        EOF

    - name: Build SSH-no-key container image
      run: |
        podman build -f Dockerfile.ssh-no-key -t spooky-test-ssh-no-key .

    - name: Start SSH containers
      run: |
        # Start 7 working SSH containers on different ports
        for i in {1..7}; do
          port=$((2220 + $i))
          container_name="spooky-test-server-$i"
          
          echo "Starting working SSH container $i on port $port..."
          podman run -d \
            --name "$container_name" \
            -p "$port:22" \
            spooky-test-ssh
        done
        
        # Start container with no SSH running (port 2228)
        echo "Starting container with no SSH on port 2228..."
        podman run -d \
          --name "spooky-test-no-ssh" \
          -p "2228:22" \
          spooky-test-no-ssh
        
        # Start container with SSH but no authorized key (port 2229)
        echo "Starting container with SSH but no key on port 2229..."
        podman run -d \
          --name "spooky-test-ssh-no-key" \
          -p "2229:22" \
          spooky-test-ssh-no-key
        
        # Wait for all containers to be ready
        echo "Waiting for all containers to be ready..."
        for i in {1..30}; do
          working_count=$(podman ps --filter name=spooky-test-server --format "{{.Status}}" | grep -c "Up" || echo "0")
          no_ssh_count=$(podman ps --filter name=spooky-test-no-ssh --format "{{.Status}}" | grep -c "Up" || echo "0")
          no_key_count=$(podman ps --filter name=spooky-test-ssh-no-key --format "{{.Status}}" | grep -c "Up" || echo "0")
          total_running=$((working_count + no_ssh_count + no_key_count))
          
          if [ "$total_running" -eq 9 ]; then
            echo "All 9 containers are running (attempt $i/30)"
            break
          fi
          echo "Waiting for containers to start... ($total_running/9 running, attempt $i/30)"
          sleep 2
        done

    - name: Update test configuration
      run: |
        # Create test configuration with all 7 servers
        cat > examples/test-environment/test-config.hcl << EOF
        # Test configuration for spooky SSH automation tool
        # Points to 7 test environment SSH servers

        # Define test servers (7 containers)
        server "spooky-test-server-1" {
          host     = "localhost"
          port     = 2221
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "primary"
          }
        }

        server "spooky-test-server-2" {
          host     = "localhost"
          port     = 2222
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "primary"
          }
        }

        server "spooky-test-server-3" {
          host     = "localhost"
          port     = 2223
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "secondary"
          }
        }

        server "spooky-test-server-4" {
          host     = "localhost"
          port     = 2224
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "secondary"
          }
        }

        server "spooky-test-server-5" {
          host     = "localhost"
          port     = 2225
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "tertiary"
          }
        }

        server "spooky-test-server-6" {
          host     = "localhost"
          port     = 2226
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "tertiary"
          }
        }

        server "spooky-test-server-7" {
          host     = "localhost"
          port     = 2227
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "tertiary"
          }
        }

        # Failure scenario servers
        server "spooky-test-no-ssh" {
          host     = "localhost"
          port     = 2228
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "failure-test"
            group       = "failure"
          }
        }

        server "spooky-test-ssh-no-key" {
          host     = "localhost"
          port     = 2229
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "failure-test"
            group       = "failure"
          }
        }

        # Test actions for parallel execution
        action "check-status-all" {
          description = "Check system status on all servers"
          command     = "uptime && df -h && echo 'Server: ' \$(hostname)"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }

        action "check-ssh-keys-all" {
          description = "Check SSH key configuration on all servers"
          command     = "ls -la ~/.ssh/ && echo 'SSH keys mounted successfully on ' \$(hostname)"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }

        action "test-connection-all" {
          description = "Test basic connectivity on all servers"
          command     = "echo 'Connection test successful on ' \$(hostname) && whoami && pwd"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }

        # Test actions for specific groups (error handling)
        action "check-primary-group" {
          description = "Check status on primary group servers"
          command     = "echo 'Primary group check on ' \$(hostname) && uptime"
          servers     = ["spooky-test-server-1", "spooky-test-server-2"]
          parallel    = true
        }

        action "check-secondary-group" {
          description = "Check status on secondary group servers"
          command     = "echo 'Secondary group check on ' \$(hostname) && df -h"
          servers     = ["spooky-test-server-3", "spooky-test-server-4"]
          parallel    = true
        }

        action "check-tertiary-group" {
          description = "Check status on tertiary group servers"
          command     = "echo 'Tertiary group check on ' \$(hostname) && free -h"
          servers     = ["spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }

        # Test action that will fail on some servers (error handling)
        action "test-error-handling" {
          description = "Test command that will fail on some servers"
          command     = "ls /nonexistent/file && echo 'This should not appear' || echo 'Error handled correctly on ' \$(hostname)"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }

        # Test actions for connection failure scenarios
        action "test-connection-failures" {
          description = "Test connection failures (no SSH, no key)"
          command     = "echo 'This should fail on failure-test servers' && hostname"
          servers     = ["spooky-test-no-ssh", "spooky-test-ssh-no-key"]
          parallel    = true
        }

        action "test-mixed-success-failure" {
          description = "Test mixed success and failure scenarios"
          command     = "echo 'Testing mixed scenarios on ' \$(hostname) && uptime"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-no-ssh", "spooky-test-ssh-no-key"]
          parallel    = true
        }

        action "test-all-servers-with-failures" {
          description = "Test all servers including failure scenarios"
          command     = "echo 'Testing on ' \$(hostname) && whoami"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7", "spooky-test-no-ssh", "spooky-test-ssh-no-key"]
          parallel    = true
        }
        EOF
        
        # Create working servers only config (7 working servers)
        cat > examples/test-environment/working-servers.hcl << EOF
        # Working servers only configuration for spooky SSH automation tool
        # Points to 7 working SSH servers

        # Define working test servers (7 containers)
        server "spooky-test-server-1" {
          host     = "localhost"
          port     = 2221
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "primary"
          }
        }

        server "spooky-test-server-2" {
          host     = "localhost"
          port     = 2222
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "primary"
          }
        }

        server "spooky-test-server-3" {
          host     = "localhost"
          port     = 2223
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "secondary"
          }
        }

        server "spooky-test-server-4" {
          host     = "localhost"
          port     = 2224
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "secondary"
          }
        }

        server "spooky-test-server-5" {
          host     = "localhost"
          port     = 2225
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "tertiary"
          }
        }

        server "spooky-test-server-6" {
          host     = "localhost"
          port     = 2226
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "tertiary"
          }
        }

        server "spooky-test-server-7" {
          host     = "localhost"
          port     = 2227
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "tertiary"
          }
        }

        # Test actions for working servers only
        action "check-status-all" {
          description = "Check system status on all working servers"
          command     = "uptime && df -h && echo 'Server: ' \$(hostname)"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }

        action "check-ssh-keys-all" {
          description = "Check SSH key configuration on all working servers"
          command     = "ls -la ~/.ssh/ && echo 'SSH keys mounted successfully on ' \$(hostname)"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }

        action "test-connection-all" {
          description = "Test basic connectivity on all working servers"
          command     = "echo 'Connection test successful on ' \$(hostname) && whoami && pwd"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-server-3", "spooky-test-server-4", "spooky-test-server-5", "spooky-test-server-6", "spooky-test-server-7"]
          parallel    = true
        }
        EOF
        
        # Create failure test config (only failure scenarios)
        cat > examples/test-environment/failure-test.hcl << EOF
        # Failure test configuration for spooky SSH automation tool
        # Points to failure scenario SSH servers

        # Failure scenario servers
        server "spooky-test-no-ssh" {
          host     = "localhost"
          port     = 2228
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "failure-test"
            group       = "failure"
          }
        }

        server "spooky-test-ssh-no-key" {
          host     = "localhost"
          port     = 2229
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "failure-test"
            group       = "failure"
          }
        }

        # Test actions for connection failure scenarios
        action "test-connection-failures" {
          description = "Test connection failures (no SSH, no key)"
          command     = "echo 'This should fail on failure-test servers' && hostname"
          servers     = ["spooky-test-no-ssh", "spooky-test-ssh-no-key"]
          parallel    = true
        }
        EOF
        
        # Create mixed test config (working + failure scenarios)
        cat > examples/test-environment/mixed-test.hcl << EOF
        # Mixed test configuration for spooky SSH automation tool
        # Points to both working and failure scenario SSH servers

        # Working servers
        server "spooky-test-server-1" {
          host     = "localhost"
          port     = 2221
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "primary"
          }
        }

        server "spooky-test-server-2" {
          host     = "localhost"
          port     = 2222
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "test-server"
            group       = "primary"
          }
        }

        # Failure scenario servers
        server "spooky-test-no-ssh" {
          host     = "localhost"
          port     = 2228
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "failure-test"
            group       = "failure"
          }
        }

        server "spooky-test-ssh-no-key" {
          host     = "localhost"
          port     = 2229
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
          tags = {
            environment = "testing"
            role        = "failure-test"
            group       = "failure"
          }
        }

        # Test actions for mixed success/failure scenarios
        action "test-mixed-success-failure" {
          description = "Test mixed success and failure scenarios"
          command     = "echo 'Testing mixed scenarios on ' \$(hostname) && uptime"
          servers     = ["spooky-test-server-1", "spooky-test-server-2", "spooky-test-no-ssh", "spooky-test-ssh-no-key"]
          parallel    = true
        }
        EOF
        
        # Create a simple test config for basic CLI testing
        cat > examples/test-environment/simple-test.hcl << EOF
        # Simple test configuration for CLI testing
        server "test-server-1" {
          host     = "localhost"
          port     = 2221
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
        }

        server "test-server-2" {
          host     = "localhost"
          port     = 2222
          user     = "testuser"
          key_file = "$HOME/.ssh/id_ed25519"
        }

        action "test-action" {
          description = "Simple test action on 2 servers"
          command     = "echo 'test successful on ' \$(hostname)"
          servers     = ["test-server-1", "test-server-2"]
          parallel    = true
        }
        EOF

    - name: Build binary
      run: |
        mkdir -p build
        go build -o build/spooky main.go
        chmod +x build/spooky
        ls -la build/

    - name: Run integration tests
      run: |
        # Set environment variables for tests
        export SPOOKY_TEST_SSH_HOST=localhost
        export SPOOKY_TEST_SSH_PORT=2221
        export SPOOKY_TEST_SSH_USER=testuser
        export SPOOKY_TEST_SSH_KEY=$HOME/.ssh/id_ed25519
        
        # Show current directory and files
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        
        echo "Files in build directory:"
        ls -la build/ || echo "Build directory not found"
        
        echo "Files in examples/test-environment:"
        ls -la examples/test-environment/ || echo "Test environment directory not found"
        
        # Final pre-test SSH connectivity verification for working containers
        echo "=== Pre-test SSH Verification for Working Containers ==="
        for i in {1..7}; do
          port=$((2220 + $i))
          container_name="spooky-test-server-$i"
          
          echo "Testing SSH connection to container $i on port $port..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p "$port" testuser@localhost "echo 'SSH connection successful - pre-test on container $i'" || {
            echo "SSH connection failed to container $i before tests - container may have become unhealthy"
            echo "Container status:"
            podman ps --filter name="$container_name"
            echo "Container logs:"
            podman logs "$container_name"
            exit 1
          }
          echo "✓ SSH connection to container $i successful"
        done
        
        # Test failure scenarios (these should fail)
        echo "=== Testing Failure Scenarios (Expected to Fail) ==="
        
        echo "Testing connection to no-SSH container (port 2228) - should fail..."
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p 2228 testuser@localhost "echo 'This should not work'" 2>/dev/null; then
          echo "✗ SSH connection to no-SSH container succeeded - this should have failed!"
          exit 1
        else
          echo "✓ SSH connection to no-SSH container correctly failed"
        fi
        
        echo "Testing connection to SSH-no-key container (port 2229) - should fail..."
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p 2229 testuser@localhost "echo 'This should not work'" 2>/dev/null; then
          echo "✗ SSH connection to SSH-no-key container succeeded - this should have failed!"
          exit 1
        else
          echo "✓ SSH connection to SSH-no-key container correctly failed"
        fi
        
        # Simple integration tests using shell commands
        echo "=== Running Simple Integration Tests ==="
        
        # Test 1: Validate command (simple config)
        echo "Testing validate command with simple config..."
        ./build/spooky validate examples/test-environment/simple-test.hcl || {
          echo "Validate command failed with simple config"
          exit 1
        }
        echo "✓ Validate command passed with simple config"
        
        # Test 2: Validate command (full config)
        echo "Testing validate command with full config..."
        ./build/spooky validate examples/test-environment/test-config.hcl || {
          echo "Validate command failed with full config"
          exit 1
        }
        echo "✓ Validate command passed with full config"
        
        # Test 3: List command (simple config)
        echo "Testing list command with simple config..."
        ./build/spooky list examples/test-environment/simple-test.hcl || {
          echo "List command failed with simple config"
          exit 1
        }
        echo "✓ List command passed with simple config"
        
        # Test 4: List command (full config)
        echo "Testing list command with full config..."
        ./build/spooky list examples/test-environment/test-config.hcl || {
          echo "List command failed with full config"
          exit 1
        }
        echo "✓ List command passed with full config"
        
        # Test 5: Execute command (simple config - 2 servers)
        echo "Testing execute command with simple config (2 servers)..."
        ./build/spooky execute examples/test-environment/simple-test.hcl || {
          echo "Execute command failed with simple config"
          exit 1
        }
        echo "✓ Execute command passed with simple config"
        
        # Test 6: Execute command (working servers only - 7 servers, parallel execution)
        echo "Testing execute command with working servers only..."
        ./build/spooky execute examples/test-environment/working-servers.hcl || {
          echo "Execute command failed with working servers config"
          exit 1
        }
        echo "✓ Execute command passed with working servers config"
        
        # Test 7: Test failure scenarios (these should fail as expected)
        echo "Testing failure scenarios (expected to fail)..."
        if ./build/spooky execute examples/test-environment/failure-test.hcl 2>/dev/null; then
          echo "✗ Failure scenario test should have failed but succeeded"
          exit 1
        else
          echo "✓ Failure scenario test correctly failed as expected"
        fi
        
        # Test 8: Test mixed success/failure scenarios (should succeed with partial failures)
        echo "Testing mixed success/failure scenarios..."
        ./build/spooky execute examples/test-environment/mixed-test.hcl || {
          echo "Mixed success/failure test failed unexpectedly"
          exit 1
        }
        echo "✓ Mixed success/failure test passed"
        
        # Test 4: Test with invalid config
        echo "Testing invalid config handling..."
        echo "invalid hcl content" > /tmp/invalid.hcl
        if ./build/spooky validate /tmp/invalid.hcl 2>/dev/null; then
          echo "✗ Validate should have failed with invalid config"
          exit 1
        else
          echo "✓ Invalid config properly rejected"
        fi
        
        # Test 5: Test with non-existent config
        echo "Testing non-existent config handling..."
        if ./build/spooky validate /tmp/nonexistent.hcl 2>/dev/null; then
          echo "✗ Validate should have failed with non-existent config"
          exit 1
        else
          echo "✓ Non-existent config properly rejected"
        fi
        
        echo "=== All Integration Tests Passed ==="

    - name: Stop containers
      if: always()
      run: |
        echo "=== Stopping containers ==="
        for i in {1..7}; do
          container_name="spooky-test-server-$i"
          echo "Stopping container $i..."
          podman stop "$container_name" || true
        done
        
        echo "Stopping failure test containers..."
        podman stop spooky-test-no-ssh || true
        podman stop spooky-test-ssh-no-key || true

    - name: Remove containers
      if: always()
      run: |
        echo "=== Removing containers ==="
        for i in {1..7}; do
          container_name="spooky-test-server-$i"
          echo "Removing container $i..."
          podman rm "$container_name" || true
        done
        
        echo "Removing failure test containers..."
        podman rm spooky-test-no-ssh || true
        podman rm spooky-test-ssh-no-key || true

    - name: Remove container images
      if: always()
      run: |
        echo "=== Removing container images ==="
        podman rmi spooky-test-ssh || true
        podman rmi spooky-test-no-ssh || true
        podman rmi spooky-test-ssh-no-key || true

    - name: Remove SSH keys
      if: always()
      run: |
        echo "=== Removing SSH keys ==="
        rm -f ~/.ssh/id_ed25519 ~/.ssh/id_ed25519.pub || true

 